<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Kassenbon OCR App â€“ Mobile + Kategorien & Filter</title>
<script>
/* ---------------------------------------------------------
   Bildverbesserung (OpenCV.js) â€“ entspricht deiner Python-Version
--------------------------------------------------------- */
function enhanceImage(srcMat) {
    let gray = new cv.Mat();
    cv.cvtColor(srcMat, gray, cv.COLOR_RGBA2GRAY);

    // Gaussian Blur
    let blur = new cv.Mat();
    cv.GaussianBlur(gray, blur, new cv.Size(5,5), 0);

    // CLAHE
    let clahe = new cv.CLAHE(3.0, new cv.Size(8,8));
    let contrast = new cv.Mat();
    clahe.apply(blur, contrast);

    // SchÃ¤rfen
    let kernel = cv.matFromArray(3, 3, cv.CV_32F,
        [0,-1,0, -1,5,-1, 0,-1,0]);
    let sharp = new cv.Mat();
    cv.filter2D(contrast, sharp, -1, kernel);

    // Rauschen reduzieren
    let denoised = new cv.Mat();
    cv.fastNlMeansDenoising(sharp, denoised, 10);

    gray.delete(); blur.delete(); contrast.delete(); sharp.delete(); kernel.delete();

    return denoised;
}

/* ---------------------------------------------------------
   OCR Pipeline
--------------------------------------------------------- */
async function runOCR(file) {
    document.getElementById("status").textContent = "Bild wird geladenâ€¦";

    let img = new Image();
    img.src = URL.createObjectURL(file);

    await img.decode();

    // Canvas â†’ OpenCV Mat
    let canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    let ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);

    let src = cv.imread(canvas);

    document.getElementById("status").textContent = "Bild wird verbessertâ€¦";

    let enhanced = enhanceImage(src);

    // ZurÃ¼ck ins Canvas
    cv.imshow(canvas, enhanced);

    document.getElementById("status").textContent = "OCR lÃ¤uftâ€¦";

    let { data: { text } } = await Tesseract.recognize(
        canvas.toDataURL(),
        "deu",
        { logger: m => console.log(m) }
    );

    src.delete();
    enhanced.delete();

    return text;
}

/* ---------------------------------------------------------
   Puter AI Namenskorrigierung
--------------------------------------------------------- */
async function correctName(name) {
    const result = await puter.ai.chat({
        model: "gpt-4o-mini",
        messages: [
            { role: "system", content: "Korrigiere Produktnamen. Gib nur den korrigierten Namen zurÃ¼ck." },
            { role: "user", content: name }
        ]
    });

    return result.message.content;
}

/* ---------------------------------------------------------
   UI Events
--------------------------------------------------------- */
document.getElementById("customFileButton").onclick = () =>
    document.getElementById("imageInput").click();

document.getElementById("imageInput").onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    document.getElementById("status").textContent = "Verarbeiteâ€¦";

    let rawText = await runOCR(file);

    document.getElementById("status").textContent = "Korrigiere Namenâ€¦";

    let corrected = await correctName(rawText);

    document.getElementById("output").textContent = corrected;
    document.getElementById("status").textContent = "Fertig!";
};
</script>
  <!-- OCR (Tesseract v5) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <!-- Puter AI -->
  <script src="https://js.puter.com/v2/"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #dbeafe;
      --bg: #f3f4f6;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --danger: #dc2626;
      --radius: 12px;

      /* Kategorie-Farben (High Contrast) */
      --cat-obst: #166534;          /* DunkelgrÃ¼n */
      --cat-fleisch: #b91c1c;       /* Dunkelrot */
      --cat-backwaren: #c2410c;     /* Dunkelorange */
      --cat-getraenke: #1d4ed8;     /* Dunkelblau */
      --cat-milch: #0f766e;         /* TÃ¼rkis */
      --cat-suess: #be185d;         /* Magenta */
      --cat-haushalt: #111827;      /* Schwarz */
      --cat-drogerie: #6d28d9;      /* Violett */
      --cat-tabak: #78350f;         /* Dunkelbraun */
      --cat-sonstiges: #374151;     /* Dunkelgrau */
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 16px;
      background: var(--card);
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }

    header small {
      color: var(--muted);
      font-size: 0.8rem;
    }

    .tabs {
      display: flex;
      margin-top: 12px;
      background: var(--bg);
      border-radius: 999px;
      padding: 4px;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 8px 4px;
      font-size: 0.85rem;
      border-radius: 999px;
      cursor: pointer;
      color: var(--muted);
      user-select: none;
    }

    .tab.active {
      background: var(--primary);
      color: #fff;
      font-weight: 600;
    }

    main {
      flex: 1;
      padding: 12px;
      padding-bottom: 72px;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    .card p {
      margin: 4px 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .file-input {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 0.9rem;
    }

    .status {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: #fff;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 8px;
    }

    .btn.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn.danger {
      background: var(--danger);
      color: #fff;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .stat {
      background: var(--primary-light);
      border-radius: var(--radius);
      padding: 8px;
      font-size: 0.8rem;
    }

    .stat-label {
      color: var(--muted);
      font-size: 0.75rem;
    }

    .stat-value {
      font-weight: 600;
      margin-top: 2px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.8rem;
    }

    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px;
    }

    th {
      background: #f9fafb;
      text-align: left;
    }

    details {
      margin-top: 8px;
      font-size: 0.8rem;
    }

    details summary {
      cursor: pointer;
      color: var(--primary);
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 0.9rem;
    }

    .settings-row input {
      width: 80px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      text-align: center;
    }

    .receipt-list {
      max-height: 260px;
      overflow-y: auto;
      margin-top: 6px;
    }

    .receipt-item {
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.8rem;
      display: flex;
      justify-content: space-between;
    }

    .receipt-item span {
      display: block;
    }

    .receipt-item-date {
      color: var(--muted);
      font-size: 0.75rem;
    }

    footer {
      position: sticky;
      bottom: 0;
      background: var(--card);
      padding: 8px 12px;
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
      border-top: 1px solid #e5e7eb;
    }

    .filter-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 0.8rem;
    }

    .filter-select {
      width: 100%;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 0.85rem;
    }

    .filter-dates {
      display: flex;
      gap: 6px;
    }

    .filter-dates input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 0.8rem;
    }

    .category-chips {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 4px;
      margin-top: 4px;
    }

    .chip {
      flex-shrink: 0;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 0.75rem;
      cursor: pointer;
      white-space: nowrap;
      background: #fff;
      color: var(--text);
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }

    .chip.active {
      color: #fff;
      border-color: transparent;
    }

    .chip.cat-obst.active { background: var(--cat-obst); }
    .chip.cat-fleisch.active { background: var(--cat-fleisch); }
    .chip.cat-backwaren.active { background: var(--cat-backwaren); }
    .chip.cat-getraenke.active { background: var(--cat-getraenke); }
    .chip.cat-milch.active { background: var(--cat-milch); }
    .chip.cat-suess.active { background: var(--cat-suess); }
    .chip.cat-haushalt.active { background: var(--cat-haushalt); }
    .chip.cat-drogerie.active { background: var(--cat-drogerie); }
    .chip.cat-tabak.active { background: var(--cat-tabak); }
    .chip.cat-sonstiges.active { background: var(--cat-sonstiges); }

    .chip.cat-obst:not(.active) { border-color: var(--cat-obst); color: var(--cat-obst); }
    .chip.cat-fleisch:not(.active) { border-color: var(--cat-fleisch); color: var(--cat-fleisch); }
    .chip.cat-backwaren:not(.active) { border-color: var(--cat-backwaren); color: var(--cat-backwaren); }
    .chip.cat-getraenke:not(.active) { border-color: var(--cat-getraenke); color: var(--cat-getraenke); }
    .chip.cat-milch:not(.active) { border-color: var(--cat-milch); color: var(--cat-milch); }
    .chip.cat-suess:not(.active) { border-color: var(--cat-suess); color: var(--cat-suess); }
    .chip.cat-haushalt:not(.active) { border-color: var(--cat-haushalt); color: var(--cat-haushalt); }
    .chip.cat-drogerie:not(.active) { border-color: var(--cat-drogerie); color: var(--cat-drogerie); }
    .chip.cat-tabak:not(.active) { border-color: var(--cat-tabak); color: var(--cat-tabak); }
    .chip.cat-sonstiges:not(.active) { border-color: var(--cat-sonstiges); color: var(--cat-sonstiges); }

    .chip-all.active {
      background: var(--primary);
      color: #fff;
      border-color: transparent;
    }
    .chip-all:not(.active) {
      border-color: var(--primary);
      color: var(--primary);
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Kassenbon OCR</h1>
    <small>Scannen Â· Speichern Â· Verbrauch auswerten</small>

    <div class="tabs">
      <div class="tab active" data-screen="scan">Scan</div>
      <div class="tab" data-screen="stats">Verbrauch</div>
      <div class="tab" data-screen="settings">Einstellungen</div>
    </div>
  </header>

  <main>
    <!-- SCAN SCREEN -->
    <section id="screen-scan" class="screen active">
      <div class="card">
        <h2>Bon scannen</h2>
        <p>Foto eines Kassenbons aufnehmen oder aus der Galerie wÃ¤hlen. Der Text wird erkannt und automatisch ausgewertet.</p>
        <input type="file" id="imageInput" accept="image/*" class="file-input">
        <div id="status" class="status"></div>
      </div>

      <div class="card">
        <h2>Letzter Scan</h2>
        <div id="output">Noch kein Bon gescannt.</div>
        <div id="tableContainer"></div>
      </div>
    </section>

    <!-- STATS SCREEN -->
    <section id="screen-stats" class="screen">
      <div class="card">
        <h2>Filter</h2>
        <div class="filter-row">
          <label for="timeFilter">Zeitraum</label>
          <select id="timeFilter" class="filter-select">
            <option value="today">Heute</option>
            <option value="yesterday">Gestern</option>
            <option value="thisWeek">Diese Woche</option>
            <option value="lastWeek">Letzte Woche</option>
            <option value="thisMonth">Dieser Monat</option>
            <option value="lastMonth">Letzter Monat</option>
            <option value="thisYear">Dieses Jahr</option>
            <option value="custom">Benutzerdefiniert</option>
          </select>
        </div>
        <div class="filter-row" id="customDateRow" style="display:none;">
          <div class="filter-dates">
            <input type="date" id="customFrom">
            <input type="date" id="customTo">
          </div>
        </div>

        <div class="filter-row">
          <span>Kategorie</span>
          <div class="category-chips" id="categoryChips">
            <div class="chip chip-all active" data-category="ALL">Alle</div>
            <div class="chip cat-obst" data-category="Obst & GemÃ¼se">Obst & GemÃ¼se</div>
            <div class="chip cat-fleisch" data-category="Fleisch & Wurst">Fleisch & Wurst</div>
            <div class="chip cat-backwaren" data-category="Backwaren">Backwaren</div>
            <div class="chip cat-getraenke" data-category="GetrÃ¤nke">GetrÃ¤nke</div>
            <div class="chip cat-milch" data-category="Milchprodukte">Milchprodukte</div>
            <div class="chip cat-suess" data-category="SÃ¼ÃŸwaren & Snacks">SÃ¼ÃŸwaren & Snacks</div>
            <div class="chip cat-haushalt" data-category="Haushalt">Haushalt</div>
            <div class="chip cat-drogerie" data-category="Drogerie & Kosmetik">Drogerie & Kosmetik</div>
            <div class="chip cat-tabak" data-category="Tabak">Tabak</div>
            <div class="chip cat-sonstiges" data-category="Sonstiges">Sonstiges</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Verbrauch â€“ Ãœbersicht</h2>
        <p>Basierend auf allen gefilterten Bons.</p>
        <div class="stats-grid" id="statsGrid"></div>
      </div>

      <div class="card">
        <h2>Gespeicherte Bons (gefiltert)</h2>
        <p>Nach Datum sortiert (neueste zuerst).</p>
        <div class="receipt-list" id="receiptList"></div>
        <button class="btn secondary danger" id="clearDataBtn">Alle Daten lÃ¶schen</button>
      </div>
    </section>

    <!-- SETTINGS SCREEN -->
    <section id="screen-settings" class="screen">
      <div class="card">
        <h2>PersÃ¶nliche Einstellungen</h2>
        <p>Nutze die GruppengrÃ¶ÃŸe, um den Verbrauch pro Person zu berechnen (z.B. 4â€‘kÃ¶pfige Familie).</p>

        <div class="settings-row">
          <span>GruppengrÃ¶ÃŸe (Personen)</span>
          <input type="number" id="groupSizeInput" min="1" value="1">
        </div>

        <button class="btn" id="saveSettingsBtn">Einstellungen speichern</button>
        <div id="settingsStatus" class="status"></div>
      </div>

      <div class="card">
        <h2>Hinweis</h2>
        <p>Alle Daten werden nur lokal in deinem Browser gespeichert (localStorage) und nicht hochgeladen.</p>
      </div>
    </section>
  </main>

  <footer>
    Daten werden lokal gespeichert Â· Ideal fÃ¼r Smartphone & Tablet
  </footer>
</div>

<script>
/* ---------------------------------------------------------
   Tabs / Screens
--------------------------------------------------------- */
const tabs = document.querySelectorAll('.tab');
const screens = {
  scan: document.getElementById('screen-scan'),
  stats: document.getElementById('screen-stats'),
  settings: document.getElementById('screen-settings')
};

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');

    const target = tab.getAttribute('data-screen');
    Object.keys(screens).forEach(key => {
      screens[key].classList.toggle('active', key === target);
    });

    if (target === 'stats') {
      renderStats();
      renderReceiptList();
    }
  });
});

/* ---------------------------------------------------------
   Local Storage â€“ Datenstruktur
   receipts: [
     { id, dateISO, dateDisplay, total, items: [{name, price, category}] }
   ]
   settings: { groupSize }
--------------------------------------------------------- */
const STORAGE_KEY_RECEIPTS = 'kassenbon_receipts_v2';
const STORAGE_KEY_SETTINGS = 'kassenbon_settings_v1';

function loadReceipts() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY_RECEIPTS);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch {
    return [];
  }
}

function saveReceipts(receipts) {
  localStorage.setItem(STORAGE_KEY_RECEIPTS, JSON.stringify(receipts));
}

function loadSettings() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY_SETTINGS);
    if (!raw) return { groupSize: 1 };
    const obj = JSON.parse(raw);
    return {
      groupSize: Number(obj.groupSize) > 0 ? Number(obj.groupSize) : 1
    };
  } catch {
    return { groupSize: 1 };
  }
}

function saveSettings(settings) {
  localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
}

/* ---------------------------------------------------------
   Tabelle rendern (ohne map)
--------------------------------------------------------- */
function renderTable(items) {
  if (!items || !items.length) return "<p>Keine Artikel erkannt.</p>";

  let html = `<table><tr><th>Artikel</th><th>Kategorie</th><th>Preis (â‚¬)</th></tr>`;
  for (const it of items) {
    const price = Number(it.price);
    const cat = it.category || "Sonstiges";
    html += `<tr><td>${it.name}</td><td>${cat}</td><td>${isNaN(price) ? it.price : price.toFixed(2)}</td></tr>`;
  }
  html += `</table>`;
  return html;
}

/* ---------------------------------------------------------
   Puter AI â€“ JSON-Extraktion (robust, mit Kategorien)
--------------------------------------------------------- */
async function extractWithPuter(ocrText) {
  // Alle geschweiften Klammern entfernen, die Puter verwirren
  ocrText = ocrText.replace(/[{}]/g, "");

  const prompt = `
Hier ist ein OCR-Kassenbontext:

${ocrText}

Du sollst:
- Produktnamen korrigieren
- OCR-Fehler bereinigen
- Artikel + Preise extrahieren
- JEDEM Artikel GENAU EINE Kategorie zuordnen
- Artikel nach Preis (aufsteigend) sortieren
- IMMER gÃ¼ltiges JSON zurÃ¼ckgeben

Erlaubte Kategorien (EXAKT so schreiben):
- "Obst & GemÃ¼se"
- "Fleisch & Wurst"
- "Backwaren"
- "GetrÃ¤nke"
- "Milchprodukte"
- "SÃ¼ÃŸwaren & Snacks"
- "Haushalt"
- "Drogerie & Kosmetik"
- "Tabak"
- "Sonstiges"

Wenn du keine Artikel findest: "items": []
Wenn du kein Datum findest: "date": ""
Wenn du keinen Gesamtbetrag findest: "total": ""

Gib das Ergebnis GENAU in diesem Format zurÃ¼ck:

{
  "date": "TT.MM.JJJJ",
  "total": "12.34",
  "items": [
    { "name": "Produkt", "price": "1.99", "category": "GetrÃ¤nke" }
  ]
}
`;

  const response = await puter.ai.chat(prompt);

  console.log("Puterâ€‘Rohantwort:", response);

  let text = "";

  if (typeof response === "string") {
    text = response;
  } else if (response?.message?.content) {
    text = response.message.content;
  } else {
    text = JSON.stringify(response);
  }

  console.log("Puterâ€‘Text (String):", text);

  try {
    const jsonStart = text.indexOf("{");
    const jsonEnd = text.lastIndexOf("}");
    const jsonString = text.substring(jsonStart, jsonEnd + 1);

    console.log("Puterâ€‘JSONâ€‘String:", jsonString);

    const parsed = JSON.parse(jsonString);

    let items = Array.isArray(parsed.items) ? parsed.items : [];
    items = items.map(it => ({
      name: it.name || "",
      price: it.price || "0.00",
      category: it.category || "Sonstiges"
    }));

    return {
      date: parsed.date || "",
      total: parsed.total || "",
      items
    };

  } catch (e) {
    console.error("JSON Parsing Fehler:", e, text);

    return {
      date: "",
      total: "",
      items: []
    };
  }
}

/* ---------------------------------------------------------
   Zeitraum-Filter Logik
--------------------------------------------------------- */
function getDateRangeForFilter(filterValue, customFrom, customTo) {
  const now = new Date();
  let start = null;
  let end = null;

  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const oneDayMs = 1000 * 60 * 60 * 24;

  switch (filterValue) {
    case 'today':
      start = new Date(today);
      end = new Date(today.getTime() + oneDayMs - 1);
      break;
    case 'yesterday':
      start = new Date(today.getTime() - oneDayMs);
      end = new Date(today.getTime() - 1);
      break;
    case 'thisWeek': {
      const day = today.getDay() || 7;
      const monday = new Date(today);
      monday.setDate(today.getDate() - (day - 1));
      start = monday;
      end = new Date(monday.getTime() + 7 * oneDayMs - 1);
      break;
    }
    case 'lastWeek': {
      const day = today.getDay() || 7;
      const mondayThisWeek = new Date(today);
      mondayThisWeek.setDate(today.getDate() - (day - 1));
      const mondayLastWeek = new Date(mondayThisWeek.getTime() - 7 * oneDayMs);
      start = mondayLastWeek;
      end = new Date(mondayLastWeek.getTime() + 7 * oneDayMs - 1);
      break;
    }
    case 'thisMonth': {
      start = new Date(now.getFullYear(), now.getMonth(), 1);
      end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
      break;
    }
    case 'lastMonth': {
      start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
      break;
    }
    case 'thisYear': {
      start = new Date(now.getFullYear(), 0, 1);
      end = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
      break;
    }
    case 'custom': {
      if (customFrom && customTo) {
        start = new Date(customFrom);
        end = new Date(customTo);
        end.setHours(23, 59, 59, 999);
      }
      break;
    }
    default:
      break;
  }

  return { start, end };
}

function filterReceiptsByDate(receipts, filterValue, customFrom, customTo) {
  const { start, end } = getDateRangeForFilter(filterValue, customFrom, customTo);
  if (!start || !end) return receipts;

  return receipts.filter(r => {
    const d = new Date(r.dateISO || r.dateDisplay || new Date());
    return d >= start && d <= end;
  });
}

function filterReceiptsByCategory(receipts, category) {
  if (!category || category === 'ALL') return receipts;
  return receipts.map(r => {
    const items = (r.items || []).filter(it => (it.category || "Sonstiges") === category);
    const total = items.reduce((sum, it) => {
      const v = Number(String(it.price).replace(",", "."));
      return sum + (isNaN(v) ? 0 : v);
    }, 0);
    return {
      ...r,
      items,
      total: total.toFixed(2)
    };
  }).filter(r => (r.items || []).length > 0);
}

/* ---------------------------------------------------------
   Verbrauchsberechnung
--------------------------------------------------------- */
function computeStats(receipts, groupSize) {
  if (!receipts.length) {
    return {
      totalAll: 0,
      avgDay: 0,
      avgWeek: 0,
      avgMonth: 0,
      avgYear: 0,
      perPerson: {
        avgDay: 0,
        avgWeek: 0,
        avgMonth: 0,
        avgYear: 0
      }
    };
  }

  const now = new Date();
  const msPerDay = 1000 * 60 * 60 * 24;

  let totalAll = 0;
  let firstDate = null;
  let lastDate = null;

  for (const r of receipts) {
    const total = Number(String(r.total).replace(",", "."));
    if (isNaN(total)) continue;

    const d = new Date(r.dateISO || r.dateDisplay || now.toISOString());
    if (!firstDate || d < firstDate) firstDate = d;
    if (!lastDate || d > lastDate) lastDate = d;

    totalAll += total;
  }

  if (!firstDate) firstDate = now;
  if (!lastDate) lastDate = now;

  const daysSpan = Math.max(1, Math.round((lastDate - firstDate) / msPerDay) + 1);

  const avgDay = totalAll / daysSpan;
  const avgWeek = avgDay * 7;
  const avgMonth = avgDay * 30;
  const avgYear = avgDay * 365;

  const perPersonFactor = groupSize > 0 ? groupSize : 1;

  return {
    totalAll,
    avgDay,
    avgWeek,
    avgMonth,
    avgYear,
    perPerson: {
      avgDay: avgDay / perPersonFactor,
      avgWeek: avgWeek / perPersonFactor,
      avgMonth: avgMonth / perPersonFactor,
      avgYear: avgYear / perPersonFactor
    }
  };
}

function formatEuro(value) {
  return value.toFixed(2).replace(".", ",") + " â‚¬";
}

/* ---------------------------------------------------------
   Stats & Liste rendern (mit Filtern)
--------------------------------------------------------- */
const timeFilterSelect = document.getElementById('timeFilter');
const customDateRow = document.getElementById('customDateRow');
const customFromInput = document.getElementById('customFrom');
const customToInput = document.getElementById('customTo');
const categoryChips = document.getElementById('categoryChips');

let currentCategoryFilter = 'ALL';

timeFilterSelect.addEventListener('change', () => {
  const val = timeFilterSelect.value;
  customDateRow.style.display = val === 'custom' ? 'block' : 'none';
  renderStats();
  renderReceiptList();
});

customFromInput.addEventListener('change', () => {
  if (timeFilterSelect.value === 'custom') {
    renderStats();
    renderReceiptList();
  }
});

customToInput.addEventListener('change', () => {
  if (timeFilterSelect.value === 'custom') {
    renderStats();
    renderReceiptList();
  }
});

categoryChips.addEventListener('click', (e) => {
  const chip = e.target.closest('.chip');
  if (!chip) return;
  const cat = chip.getAttribute('data-category');
  currentCategoryFilter = cat || 'ALL';

  categoryChips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');

  renderStats();
  renderReceiptList();
});

function getFilteredReceipts() {
  const receipts = loadReceipts().slice().sort((a, b) => {
    return (b.dateISO || "").localeCompare(a.dateISO || "");
  });

  const timeFilter = timeFilterSelect.value;
  const customFrom = customFromInput.value || null;
  const customTo = customToInput.value || null;

  let filtered = filterReceiptsByDate(receipts, timeFilter, customFrom, customTo);
  filtered = filterReceiptsByCategory(filtered, currentCategoryFilter);

  return filtered;
}

function renderStats() {
  const receipts = getFilteredReceipts();
  const settings = loadSettings();
  const stats = computeStats(receipts, settings.groupSize);

  const grid = document.getElementById('statsGrid');
  grid.innerHTML = `
    <div class="stat">
      <div class="stat-label">Gesamt (gefiltert)</div>
      <div class="stat-value">${formatEuro(stats.totalAll)}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Ã˜ pro Tag</div>
      <div class="stat-value">${formatEuro(stats.avgDay)}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Ã˜ pro Woche</div>
      <div class="stat-value">${formatEuro(stats.avgWeek)}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Ã˜ pro Monat</div>
      <div class="stat-value">${formatEuro(stats.avgMonth)}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Ã˜ pro Jahr</div>
      <div class="stat-value">${formatEuro(stats.avgYear)}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Ã˜ pro Tag / Person</div>
      <div class="stat-value">${formatEuro(stats.perPerson.avgDay)}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Ã˜ pro Woche / Person</div>
      <div class="stat-value">${formatEuro(stats.perPerson.avgWeek)}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Ã˜ pro Monat / Person</div>
      <div class="stat-value">${formatEuro(stats.perPerson.avgMonth)}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Ã˜ pro Jahr / Person</div>
      <div class="stat-value">${formatEuro(stats.perPerson.avgYear)}</div>
    </div>
  `;
}

function renderReceiptList() {
  const receipts = getFilteredReceipts();
  const list = document.getElementById('receiptList');
  if (!receipts.length) {
    list.innerHTML = "<p>Keine Bons im aktuellen Filter.</p>";
    return;
  }

  let html = "";
  for (const r of receipts) {
    html += `
      <div class="receipt-item">
        <span>
          <strong>${formatEuro(Number(String(r.total).replace(",", ".")) || 0)}</strong>
          <span class="receipt-item-date">${r.dateDisplay || r.dateISO}</span>
        </span>
        <span>${(r.items || []).length} Artikel</span>
      </div>
    `;
  }
  list.innerHTML = html;
}

/* ---------------------------------------------------------
   Einstellungen initialisieren
--------------------------------------------------------- */
const groupSizeInput = document.getElementById('groupSizeInput');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const settingsStatus = document.getElementById('settingsStatus');

function initSettingsUI() {
  const settings = loadSettings();
  groupSizeInput.value = settings.groupSize;
}

saveSettingsBtn.addEventListener('click', () => {
  const size = Number(groupSizeInput.value);
  const validSize = size > 0 ? Math.round(size) : 1;
  groupSizeInput.value = validSize;
  saveSettings({ groupSize: validSize });
  settingsStatus.textContent = "Einstellungen gespeichert.";
  setTimeout(() => settingsStatus.textContent = "", 2000);
});

/* ---------------------------------------------------------
   Daten lÃ¶schen
--------------------------------------------------------- */
document.getElementById('clearDataBtn').addEventListener('click', () => {
  if (!confirm("Alle gespeicherten Bons lÃ¶schen?")) return;
  saveReceipts([]);
  renderStats();
  renderReceiptList();
});

/* ---------------------------------------------------------
   Hauptlogik: OCR â†’ Puter â†’ Tabelle + Speichern
--------------------------------------------------------- */
document.getElementById("imageInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const status = document.getElementById("status");
  const output = document.getElementById("output");
  const tableContainer = document.getElementById("tableContainer");

  status.textContent = "OCR lÃ¤uft...";

  const worker = await Tesseract.createWorker("deu");
  const { data } = await worker.recognize(file);
  await worker.terminate();

  const rawText = data.text;
  console.log("Roh-OCR:", rawText);

  status.textContent = "OCR abgeschlossen. Sende Text an Puter AI...";

  const result = await extractWithPuter(rawText);

  if (!result) {
    status.textContent = "Fehler bei der KI-Extraktion.";
    return;
  }

  status.textContent = "Extraktion abgeschlossen.";

  const date = result.date || "";
  const total = result.total || "0,00";
  const items = Array.isArray(result.items) ? result.items : [];

  output.innerHTML =
    `<strong>ðŸ“… Datum:</strong> ${date || "Nicht erkannt"}<br>` +
    `<strong>ðŸ’¶ Gesamtbetrag:</strong> ${total} â‚¬<br><br>` +
    `<strong>ðŸ›’ Artikel:</strong><br>`;

  tableContainer.innerHTML = renderTable(items);

  output.innerHTML += `<details><summary>Roh-JSON anzeigen</summary><pre>${JSON.stringify(result, null, 2)}</pre></details>`;

  // Bon speichern
  const receipts = loadReceipts();
  const now = new Date();
  let dateISO = now.toISOString();
  let dateDisplay = date;

  if (date) {
    const m = date.match(/(\d{2})\.(\d{2})\.(\d{4})/);
    if (m) {
      const d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
      if (!isNaN(d.getTime())) {
        dateISO = d.toISOString();
        dateDisplay = date;
      }
    }
  }

  receipts.push({
    id: Date.now(),
    dateISO,
    dateDisplay,
    total: String(total).replace(",", "."),
    items
  });

  saveReceipts(receipts);

  renderStats();
  renderReceiptList();
});

/* ---------------------------------------------------------
   Init
--------------------------------------------------------- */
initSettingsUI();
renderStats();
renderReceiptList();
</script>
</body>
</html>
