    .receipt-item { padding: 12px 0; border-bottom: 1px solid var(--border); }
    .receipt-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .receipt-details { display: none; margin-top: 10px; background: var(--bg); padding: 12px; border-radius: 8px; }
    .receipt-details.open { display: block; }
    
    .detail-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .detail-table td { padding: 6px 0; border-bottom: 1px dotted var(--border); }
    .del-btn { color: var(--danger); font-size: 0.75rem; background: none; border: none; padding: 8px 0; cursor: pointer; font-weight: 600; }
    .file-label { display: block; padding: 30px; border: 2px dashed var(--primary); border-radius: var(--radius); text-align: center; color: var(--primary); cursor: pointer; font-weight: 600; }
    
    input[type="number"], select, .toggle-row { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); margin-top: 5px; }
    .toggle-row { display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Kassenbon Pro</h1>
    <div class="tabs">
      <div class="tab active" data-screen="scan">Scan</div>
      <div class="tab" data-screen="stats">Verbrauch</div>
      <div class="tab" data-screen="settings">Optionen</div>
    </div>
  </header>

  <main>
    <section id="screen-scan" class="screen active">
      <div class="card">
        <h2>Bons einlesen</h2>
        <input type="file" id="imgInp" accept="image/*" multiple style="display:none">
        <label for="imgInp" class="file-label">üì∏ Tippen zum Scannen</label>
        <div id="status" style="font-size:0.8rem; margin-top:10px; color:var(--text-muted); text-align:center"></div>
      </div>
      <div id="latest-scan-container"></div>
    </section>

    <section id="screen-stats" class="screen">
      <div class="stats-container">
        <div class="left-col">
          <div id="budget-card-container"></div>
          <div id="inflation-container"></div>
          <div id="price-watchdog-container"></div>
          <div class="card">
            <button class="btn ai" id="aiBtn">‚ú® KI Spar-Analyse</button>
            <div id="aiRes"></div>
          </div>
        </div>
        <div class="right-col">
          <div class="card">
            <h2>Filter</h2>
            <div class="category-chips" id="catChips">
              <div class="chip active" data-cat="ALL">Alle</div>
              <div class="chip" data-cat="Obst & Gem√ºse">Obst & Gem√ºse</div>
              <div class="chip" data-cat="Fleisch & Wurst">Fleisch & Wurst</div>
              <div class="chip" data-cat="Backwaren">Backwaren</div>
              <div class="chip" data-cat="Getr√§nke">Getr√§nke</div>
              <div class="chip" data-cat="Milchprodukte">Milchprodukte</div>
              <div class="chip" data-cat="S√º√üwaren">S√º√üwaren</div>
              <div class="chip" data-cat="Haushalt">Haushalt</div>
              <div class="chip" data-cat="Drogerie">Drogerie</div>
              <div class="chip" data-cat="Tabak">Tabak</div>
              <div class="chip" data-cat="Sonstiges">Sonstiges</div>
            </div>
            <div class="stats-grid" id="statGrid"></div>
          </div>
          <div class="card">
            <h2>Historie</h2>
            <div id="hist"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="screen-settings" class="screen">
      <div class="card">
        <h2>Budget Planung</h2>
        <label>Monatliches Limit (‚Ç¨):</label>
        <input type="number" id="budgetInput" placeholder="z.B. 400">
      </div>
      <div class="card">
        <h2>Ansicht & Design</h2>
        <div class="toggle-row">
          <span>Desktop-Optimierung</span>
          <input type="checkbox" id="desktopToggle">
        </div>
        <br>
        <label for="thm">Farbschema:</label>
        <select id="thm">
          <option value="default">üîµ Standard Blau</option>
          <option value="dark">üåë Dark Mode</option>
          <option value="nature">üåø Natur Gr√ºn</option>
          <option value="berry">üçì Beere Pink</option>
          <option value="ocean">üåä Ozean T√ºrkis</option>
          <option value="sunset">üåá Sunset Orange</option>
          <option value="gold">‚ú® Gold Edition</option>
        </select>
      </div>
      <div class="card">
        <h2>Daten</h2>
        <button class="btn" style="background:var(--danger)" onclick="if(confirm('Alles l√∂schen?')){localStorage.clear();location.reload()}">Alle Daten l√∂schen</button>
      </div>
    </section>
  </main>
</div>

<script>
const DB_KEY = 'receipts_v11_budget';

// FIXED: Puter Configuration
if (typeof puter !== 'undefined' && puter.ui && typeof puter.ui.useSettings === 'function') {
  puter.ui.useSettings({
    appName: "Kassenbon Pro",
    forcePopup: false
  });
}

/* Navigation */
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab, .screen').forEach(el => el.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('screen-' + t.dataset.screen).classList.add('active');
    if(t.dataset.screen === 'stats') render();
  });
});

/* OCR */
document.getElementById('imgInp').addEventListener('change', async (e) => {
  const status = document.getElementById('status');
  for(let file of e.target.files) {
    status.textContent = `Scanne...`;
    const worker = await Tesseract.createWorker("deu");
    const { data } = await worker.recognize(file);
    await worker.terminate();
    try {
      const res = await puter.ai.chat(`Analysiere Bon: Shop, Summe, Artikel+Kategorie. Antworte NUR JSON: {"shop":"Name","total":0.00,"items":[{"n":"Name","p":0.00,"c":"Kategorie"}]}. Text: ${data.text}`);
      const json = JSON.parse(res.message.content.match(/\{.*\}/s)[0]);
      const db = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
      db.push({...json, date: new Date().toLocaleDateString(), timestamp: Date.now(), id: Date.now()});
      localStorage.setItem(DB_KEY, JSON.stringify(db));
      document.getElementById('latest-scan-container').innerHTML = `<div class="card">‚úÖ Erfasst: ${json.shop}</div>`;
    } catch(err) { console.error(err); }
  }
  status.textContent = "Bereit.";
});

/* Inflations-Tracker Logik */
function checkInflation(db) {
  const productHistory = {};
  // Sortiere nach Zeit (alt nach neu)
  db.sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0)).forEach(r => {
    r.items.forEach(i => {
      const name = i.n.toUpperCase().trim();
      if(!productHistory[name]) productHistory[name] = [];
      productHistory[name].push({ p: i.p, d: r.date });
    });
  });

  let html = "";
  for(const name in productHistory) {
    const history = productHistory[name];
    if(history.length > 1) {
      const last = history[history.length - 1];
      const prev = history[history.length - 2];
      if(last.p > prev.p) {
        const diff = ((last.p - prev.p) / prev.p * 100).toFixed(0);
        html += `<div class="inflation-card">üìà <b>Teuerungs-Alarm: ${name}</b><br>Von ${prev.p.toFixed(2)}‚Ç¨ auf ${last.p.toFixed(2)}‚Ç¨ (+${diff}%)</div>`;
      }
    }
  }
  document.getElementById('inflation-container').innerHTML = html ? `<h2>Inflation-Check</h2>${html}` : "";
}

/* Budget Logik */
function renderBudget(currentSum) {
  const limit = parseFloat(localStorage.getItem('monthly_budget') || 0);
  if(limit <= 0) return;
  
  const percent = Math.min((currentSum / limit) * 100, 100);
  let statusClass = "";
  if(percent > 90) statusClass = "danger";
  else if(percent > 70) statusClass = "warning";

  document.getElementById('budget-card-container').innerHTML = `
    <div class="card">
      <div style="display:flex; justify-content:space-between; font-weight:bold">
        <span>Monats-Budget</span>
        <span>${currentSum.toFixed(2)} / ${limit}‚Ç¨</span>
      </div>
      <div class="progress-bg">
        <div class="progress-fill ${statusClass}" style="width: ${percent}%"></div>
      </div>
    </div>
  `;
}

function render() {
  const db = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
  
  // Preis-Wachhund & Inflation
  checkInflation(db);
  
  let filtered = db.map(r => {
    const items = currentCat === "ALL" ? r.items : r.items.filter(i => i.c === currentCat);
    return {...r, viewItems: items, viewTotal: items.reduce((s,i) => s + i.p, 0)};
  }).filter(r => r.viewTotal > 0);

  const sum = filtered.reduce((s, r) => s + r.viewTotal, 0);
  renderBudget(sum);

  document.getElementById('statGrid').innerHTML = `<div class="stat"><span class="stat-val">${sum.toFixed(2)}‚Ç¨</span>Summe</div><div class="stat"><span class="stat-val">${filtered.length}</span>Bons</div>`;
  document.getElementById('hist').innerHTML = filtered.reverse().map(r => `
    <div class="receipt-item">
      <div class="receipt-header" onclick="document.getElementById('details-${r.id}').classList.toggle('open')">
        <span><b>${r.shop}</b><br><small>${r.date}</small></span>
        <span><b>${r.viewTotal.toFixed(2)}‚Ç¨</b> ‚ñæ</span>
      </div>
      <div class="receipt-details" id="details-${r.id}">
        <table class="detail-table">${r.viewItems.map(i => `<tr><td>${i.n}</td><td style="text-align:right"><b>${i.p.toFixed(2)}‚Ç¨</b></td></tr>`).join('')}</table>
        <button class="del-btn" onclick="deleteReceipt(${r.id})">üóëÔ∏è Entfernen</button>
      </div>
    </div>
  `).join('');
}

/* Settings Events */
document.getElementById('budgetInput').addEventListener('input', (e) => {
  localStorage.setItem('monthly_budget', e.target.value);
  render();
});
document.getElementById('budgetInput').value = localStorage.getItem('monthly_budget');

/* Standard Funktionen */
let currentCat = "ALL";
document.getElementById('catChips').addEventListener('click', (e) => {
  const chip = e.target.closest('.chip');
  if(chip) {
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    currentCat = chip.dataset.cat;
    render();
  }
});

function deleteReceipt(id) {
  if(confirm('L√∂schen?')) {
    let db = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
    localStorage.setItem(DB_KEY, JSON.stringify(db.filter(r => r.id !== id)));
    render();
  }
}

document.getElementById('aiBtn').addEventListener('click', async () => {
  const db = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
  if(!db.length) return;
  const res = await puter.ai.chat(`Spar-Tipps f√ºr DE basierend auf diesen K√§ufen:\n${db.slice(-5).map(r=>r.total+'‚Ç¨ bei '+r.shop).join('\n')}`);
  document.getElementById('aiRes').innerHTML = `<div class="ai-box">${res.message.content.replace(/\n/g,'<br>')}</div>`;
});

const thmSelect = document.getElementById('thm');
thmSelect.addEventListener('change', (e) => { document.body.setAttribute('data-theme', e.target.value); localStorage.setItem('theme', e.target.value); });
const savedTheme = localStorage.getItem('theme');
if(savedTheme) { document.body.setAttribute('data-theme', savedTheme); thmSelect.value = savedTheme; }

// Initialer Aufruf
render();
</script>
</body>
</html>
